<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>预算列表 - 工程预算管理系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36D399',
            warning: '#FFAB00',
            danger: '#F87272',
            neutral: '#3D4451',
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gray-50 font-inter text-neutral min-h-screen">
  <!-- 顶部导航 -->
  <header class="bg-white shadow-sm sticky top-0 z-40">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <i class="fa fa-calculator text-primary text-2xl"></i>
        <h1 class="text-xl font-bold text-primary">工程预算管理系统</h1>
      </div>
      
      <nav class="hidden md:flex items-center space-x-6">
        <a href="index.html" class="text-neutral hover:text-primary transition-colors duration-200 flex items-center">
          <i class="fa fa-home mr-1"></i> 首页
        </a>
        <a href="#" class="text-primary font-medium flex items-center">
          <i class="fa fa-list-alt mr-1"></i> 预算列表
        </a>
        <a href="#" class="text-neutral hover:text-primary transition-colors duration-200 flex items-center">
          <i class="fa fa-line-chart mr-1"></i> 统计分析
        </a>
      </nav>
      
      <div class="flex items-center space-x-4">
        <span id="currentUser">用户</span>
        <button id="logoutBtn" class="text-neutral hover:text-primary transition-colors duration-200">
          <i class="fa fa-sign-out"></i> 登出
        </button>
      </div>
    </div>
  </header>

  <!-- 主要内容区 -->
  <main class="container mx-auto px-4 py-6">
    <div class="bg-white rounded-lg shadow-sm p-6">
      <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-bold text-neutral mb-1">预算列表</h2>
          <p class="text-neutral/60 text-sm">查看和管理所有项目预算</p>
        </div>
        <div class="mt-4 md:mt-0">
          <a href="index.html" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-md transition-colors duration-200 flex items-center">
            <i class="fa fa-plus mr-2"></i> 新建预算
          </a>
        </div>
      </div>
      
      <!-- 预算列表表格 -->
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral/70 uppercase tracking-wider">预算ID</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral/70 uppercase tracking-wider">项目名称</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral/70 uppercase tracking-wider">创建人</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral/70 uppercase tracking-wider">创建时间</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral/70 uppercase tracking-wider">状态</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral/70 uppercase tracking-wider">预算总额</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-neutral/70 uppercase tracking-wider">操作</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200" id="budgetTableBody">
            <!-- 动态加载的预算数据 -->
          </tbody>
        </table>
      </div>
      
      <!-- 加载状态 -->
      <div id="loadingState" class="text-center py-8">
        <i class="fa fa-spinner fa-spin text-2xl text-primary"></i>
        <p class="mt-2 text-neutral/60">正在加载预算数据...</p>
      </div>
      
      <!-- 空状态 -->
      <div id="emptyState" class="text-center py-8" style="display: none;">
        <i class="fa fa-file-text-o text-4xl text-neutral/30"></i>
        <p class="mt-2 text-neutral/60">暂无预算数据</p>
        <a href="index.html" class="mt-4 inline-block bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-md transition-colors duration-200">
          创建第一个预算
        </a>
      </div>
    </div>
  </main>

  <!-- JavaScript -->
  <script>
    // API基础URL
    const API_BASE_URL = 'http://localhost:5001/api';
    
    // 页面加载时检查登录状态并加载数据
    document.addEventListener('DOMContentLoaded', function() {
      loadBudgets();
    });
    
    // 加载预算列表
    async function loadBudgets() {
      try {
        const response = await fetch(`${API_BASE_URL}/budgets`, {
          credentials: 'include'
        });
        
        if (response.status === 401) {
          // 未登录，跳转到登录页面
          window.location.href = 'index.html';
          return;
        }
        
        if (response.ok) {
          const budgets = await response.json();
          displayBudgets(budgets);
        } else {
          console.error('加载预算列表失败');
          showEmptyState();
        }
      } catch (error) {
        console.error('加载预算列表错误:', error);
        showEmptyState();
      }
    }
    
    // 显示预算列表
    function displayBudgets(budgets) {
      const tableBody = document.getElementById('budgetTableBody');
      const loadingState = document.getElementById('loadingState');
      const emptyState = document.getElementById('emptyState');
      
      loadingState.style.display = 'none';
      
      if (budgets.length === 0) {
        showEmptyState();
        return;
      }
      
      emptyState.style.display = 'none';
      
      tableBody.innerHTML = budgets.map(budget => {
        const statusColors = {
          '待审': 'bg-yellow-100 text-yellow-800',
          '已审批': 'bg-green-100 text-green-800',
          '已拒绝': 'bg-red-100 text-red-800'
        };
        
        return `
          <tr class="hover:bg-gray-50 transition-colors duration-200">
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-neutral">
              #${budget.id}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral">
              ${budget.project_name}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral">
              ${budget.creator_name}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral">
              ${budget.create_time}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 py-1 text-xs rounded-full ${statusColors[budget.status] || 'bg-gray-100 text-gray-800'}">
                ${budget.status}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-neutral">
              ¥${budget.total_amount.toLocaleString()}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-neutral">
              <button onclick="viewBudget(${budget.id})" class="text-primary hover:text-primary/80 transition-colors duration-200 mr-3">
                <i class="fa fa-eye"></i> 查看
              </button>
              <button onclick="editBudget(${budget.id})" class="text-secondary hover:text-secondary/80 transition-colors duration-200">
                <i class="fa fa-edit"></i> 编辑
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }
    
    // 显示空状态
    function showEmptyState() {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('emptyState').style.display = 'block';
    }
    
    // 查看预算详情
    function viewBudget(budgetId) {
      window.open(`budget-detail.html?id=${budgetId}`, '_blank');
    }
    
    // 编辑预算
    function editBudget(budgetId) {
      window.location.href = `index.html?edit=${budgetId}`;
    }
    
    // 登出功能
    document.getElementById('logoutBtn').addEventListener('click', async function() {
      try {
        await fetch(`${API_BASE_URL}/logout`, {
          method: 'POST',
          credentials: 'include'
        });
        window.location.href = 'index.html';
      } catch (error) {
        console.error('登出错误:', error);
      }
    });
  </script>
</body>
</html>
